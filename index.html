<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ©˜æ¹¾å²¸ï¼±ï¼²2025ç§‹</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.png" type="image/png">
  <meta name="theme-color" content="#003366">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').then(function(registration) {
        console.log('ServiceWorker registered with scope:', registration.scope);
      }).catch(function(error) {
        console.log('ServiceWorker registration failed:', error);
      });
    }
  </script>

  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f0f0f0; font-size: 18px; }
    #title-banner {
      background-color: #003366; /* ç´ºè‰²èƒŒæ™¯ */
      color: white;              /* ç™½æŠœãæ–‡å­— */
      padding: 20px;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
    }
    /* ç”»é¢ã‚¨ãƒªã‚¢ */
    #setup, #reader, #result, #history-view, #stats-view, #report-view, #retire-list-view { margin: 20px; }
    
    #setup input, #setup select {
      text-align: left;
      text-indent: 2em;
      width: 80%;
      margin-bottom: 10px;
      font-size: 20px;
    }
    video {
      width: 90vw;
      height: 90vw;
      margin-top: 10px;
      object-fit: cover;
    }
    
    input, select, button { padding: 12px; font-size: 20px; margin: 8px; }
    #message { font-size: 22px; font-weight: bold; color: green; margin: 15px; }

    /* ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .save-button, .start-button, .history-button, .stats-button, .report-button, .retire-button, .retire-list-button {
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 20px;
      border-radius: 8px;
      box-shadow: 0 5px #444444;
      cursor: pointer;
      display: inline-block;
      margin-top: 15px;
    }
    .save-button, .start-button {
      background: linear-gradient(#888888, #666666);
    }
    /* æ©Ÿèƒ½ç³»ãƒœã‚¿ãƒ³ï¼ˆé’ç³»ï¼‰ */
    .history-button, .stats-button, .report-button {
      background: linear-gradient(#4a90e2, #003366);
    }
    /* ãƒªã‚¿ã‚¤ãƒ¤ç™»éŒ²ãƒœã‚¿ãƒ³ï¼ˆèµ¤ç³»ï¼‰ */
    .retire-button {
      background: linear-gradient(#d32f2f, #8e0000); 
    }
    /* â–¼â–¼â–¼ ãƒªã‚¿ã‚¤ãƒ¤ä¸€è¦§ãƒœã‚¿ãƒ³ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ã€œèµ¤ç³»ï¼‰æ–°è¦è¿½åŠ  â–¼â–¼â–¼ */
    .retire-list-button {
      background: linear-gradient(#d32f2f, #8e0000);
    }

    .save-button:active, .start-button:active, .history-button:active, .stats-button:active, .report-button:active, .retire-button:active, .retire-list-button:active {
      box-shadow: 0 2px #444444;
      transform: translateY(3px);
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .history-table, .stats-table, .report-table, .retire-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
      font-size: 13px;
    }
    .history-table th, .history-table td, 
    .stats-table th, .stats-table td,
    .report-table th, .report-table td,
    .retire-table th, .retire-table td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
      line-height: 1.2;
    }
    .history-table th, .stats-table th, .report-table th, .retire-table th {
      background-color: #eee;
      white-space: nowrap;
      font-size: 12px;
    }
    /* å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼è‰²åˆ†ã‘ */
    .stats-table th { background-color: #d0e0f0; }
    .report-table th { background-color: #ffe0b2; }
    /* â–¼â–¼â–¼ ãƒªã‚¿ã‚¤ãƒ¤ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆè–„ã„èµ¤ï¼‰æ–°è¦è¿½åŠ  â–¼â–¼â–¼ */
    .retire-table th { background-color: #ffcdd2; }

    #popup-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #popup {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      width: 80%;
      max-width: 400px;
    }
    #popup h2 { margin-top: 0; font-size: 24px; }
    #popup p { margin: 5px 0; font-size: 20px; }
    #popup button { padding: 10px 20px; margin: 10px; font-size: 20px; }
    /* ãƒªã‚¿ã‚¤ãƒ¤é€Ÿå ±ãƒãƒŠãƒ¼ */
    #retire-banner {
      position: fixed;
      top: -100px; 
      left: 0;
      width: 100%;
      background-color: #d32f2f; 
      color: white;
      padding: 15px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      z-index: 10000; 
      transition: top 0.5s ease-in-out;
      box-sizing: border-box;
    }
    #retire-banner h3 {
      margin: 0;
      font-size: 24px;
      font-weight: bold;
      color: #fff;
    }
    #retire-banner p {
      margin: 5px 0 0;
      font-size: 18px;
    }
  </style>
</head>

<body>

<div id="title-banner">æ©˜æ¹¾å²¸ï¼±ï¼²2025ç§‹</div>
<div id="retire-banner">
  <h3>âš  ãƒªã‚¿ã‚¤ãƒ¤é€Ÿå ±</h3>
  <p id="retire-info"></p>
</div>
<div id="setup">
  <h2 style="text-align:left; margin-left: 2em;">æ‹…å½“è€…åã¨åœ°ç‚¹ã‚’è¨­å®š</h2>
  <input type="text" id="staffName" placeholder="æ‹…å½“è€…åã‚’å…¥åŠ›">
  <br>
  <select id="location">
    <option value="">åœ°ç‚¹ã‚’é¸æŠ</option>
  </select>
  <br>
  <button class="start-button" onclick="startApp()">èª­ã¿å–ã‚Šé–‹å§‹</button>
  <br>
  <button class="history-button" onclick="showHistory()">å±¥æ­´ç¢ºèª</button>
  <button class="stats-button" onclick="showStats()">é€šéçŠ¶æ³</button>
  <br>
  <button class="report-button" onclick="showReport()">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€Ÿå ±</button>
  <br>
  <button class="retire-button" onclick="startRetireScan()">ãƒªã‚¿ã‚¤ãƒ¤ç™»éŒ²</button>
  <button class="retire-list-button" onclick="showRetireList()">ãƒªã‚¿ã‚¤ãƒ¤ãƒªã‚¹ãƒˆ</button>
</div>
  
<div id="history-view" style="display:none;">
  <h3>èª­ã¿å–ã‚Šå±¥æ­´</h3>
  <p style="font-size:16px; margin:0;">æ‹…å½“: <span id="history-staff-display" style="font-weight:bold;"></span></p>
  <div id="history-list">ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­...</div>
  <br>
  <button class="save-button" onclick="closeHistory()">æˆ»ã‚‹</button>
</div>

<div id="stats-view" style="display:none;">
  <h3>é€šéçŠ¶æ³ä¸€è¦§</h3>
  <div id="stats-list">é›†è¨ˆä¸­...</div>
  <br>
  <button class="save-button" onclick="closeStats()">æˆ»ã‚‹</button>
</div>

<div id="report-view" style="display:none;">
  <h3>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€Ÿå ±</h3>
  <div style="text-align: center; margin-bottom: 10px;">
    <select id="report-division-select" onchange="updateReportView()" style="width: 90%; font-size: 18px;">
      <option value="">éƒ¨é–€ã‚’é¸æŠ...</option>
    </select>
  </div>
  <div id="report-list">ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­...</div>
  <br>
  <button class="save-button" onclick="closeReport()">æˆ»ã‚‹</button>
</div>

<div id="retire-list-view" style="display:none;">
  <h3>ãƒªã‚¿ã‚¤ãƒ¤ä¸€è¦§</h3>
  <div id="retire-list-content">ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­...</div>
  <br>
  <button class="save-button" onclick="closeRetireList()">æˆ»ã‚‹</button>
</div>
<div id="reader" style="display:none;">
  <h3 id="message">èª­ã¿å–ã‚Šä¸­...</h3>
  <video id="video" playsinline></video>
  <br>
  <button class="save-button" onclick="endApp()">çµ‚äº†</button>
  <button class="history-button" onclick="showHistory()">å±¥æ­´ç¢ºèª</button>
</div>

<div id="result" style="display:none;">
  <div id="latest"></div>
</div>

<div id="popup-overlay">
  <div id="popup">
    <h2 id="popup-title">ãƒã‚§ãƒƒã‚¯OK</h2>
    <p id="popup-info"></p>
    </div>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
// â–¼â–¼â–¼ 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨Firebaseè¨­å®š â–¼â–¼â–¼
let firestore;
let staff = '';
let selectedLocationId = '';
let selectedLocationName = '';
let codeReader = null;
let locations = []; 
// é€Ÿå ±ç”¨ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ä¿æŒ
let allScanDataForReport = [];

const firebaseConfig = {
  apiKey: "AIzaSyD_Aic5iQ7OYGO9qTv0patspCKbwsuYcs8",
  authDomain: "tachibana-wangan.firebaseapp.com",
  projectId: "tachibana-wangan",
  storageBucket: "tachibana-wangan.firebasestorage.app",
  messagingSenderId: "963128842192",
  appId: "1:963128842192:web:5ee0eb05d3df5e7c63cbd5"
};

// â–¼â–¼â–¼ 2. é–¢æ•°å®šç¾© â–¼â–¼â–¼

async function initializeAppLogic() {
  const savedStaff = localStorage.getItem('staffName');
  const savedLocationId = localStorage.getItem('locationId');
  
  if (savedStaff) document.getElementById('staffName').value = savedStaff;

  const locationSelect = document.getElementById('location');
  
  locationSelect.innerHTML = '<option value="">åœ°ç‚¹ãƒã‚¹ã‚¿ãƒ¼èª­è¾¼ä¸­...</option>';
  locationSelect.disabled = true;

  try {
    const snapshot = await firestore.collection("locations_master")
                                    .orderBy("id", "asc")
                                    .get();

    if (snapshot.empty) {
      console.error("åœ°ç‚¹ãƒã‚¹ã‚¿ãƒ¼ãŒç©ºã§ã™ã€‚");
      locationSelect.innerHTML = '<option value="">åœ°ç‚¹å–å¾—å¤±æ•—</option>';
      return;
    }

    locations = [];
    locationSelect.innerHTML = '<option value="">åœ°ç‚¹ã‚’é¸æŠ</option>';

    snapshot.forEach(doc => {
      const loc = doc.data();
      locations.push(loc); 

      const option = document.createElement('option');
      option.value = loc.id;
      option.textContent = loc.name;
      locationSelect.appendChild(option);
    });
    
    if (savedLocationId) {
      locationSelect.value = savedLocationId;
    }

  } catch (err) {
    console.error("åœ°ç‚¹ãƒã‚¹ã‚¿ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
    locationSelect.innerHTML = '<option value="">èª­è¾¼ã‚¨ãƒ©ãƒ¼</option>';
  } finally {
    locationSelect.disabled = false;
  }
}

function startApp() {
  staff = document.getElementById('staffName').value.trim();
  const locationId = document.getElementById('location').value;

  if (!staff || !locationId) {
    showCustomPopup({
      title: "ç¢ºèª",
      message: "æ‹…å½“è€…åã¨åœ°ç‚¹ã‚’å…¥åŠ›ãƒ»é¸æŠã—ã¦ãã ã•ã„ã€‚",
      buttons: [{ text: "OK", value: true }]
    });
    return;
  }
  
  localStorage.setItem('staffName', staff);
  selectedLocationId = locationId;
  selectedLocationName = locations.find(loc => loc.id == locationId).name;

  localStorage.setItem('locationId', selectedLocationId);
  localStorage.setItem('locationName', selectedLocationName); 

  document.getElementById('setup').style.display = 'none';
  document.getElementById('reader').style.display = '';
  document.getElementById('result').style.display = '';

  startScanner();
}

function startRetireScan() {
  staff = document.getElementById('staffName').value.trim();
  if (!staff) {
    showCustomPopup({
      title: "ç¢ºèª",
      message: "æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
      buttons: [{ text: "OK", value: true }]
    });
    return;
  }
  localStorage.setItem('staffName', staff);

  selectedLocationId = '99';
  
  const retireLoc = locations.find(loc => String(loc.id) === '99');
  selectedLocationName = retireLoc ? retireLoc.name : "ãƒªã‚¿ã‚¤ãƒ¤";

  document.getElementById('setup').style.display = 'none';
  document.getElementById('reader').style.display = '';
  document.getElementById('result').style.display = '';

  startScanner();
}

// --- å±¥æ­´ç³»é–¢æ•° ---
async function showHistory() {
  const staffInput = document.getElementById('staffName').value.trim();
  if (!staffInput) {
    showCustomPopup({
      title: "ç¢ºèª",
      message: "å±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
      buttons: [{ text: "OK", value: true }]
    });
    return;
  }
  if (codeReader) codeReader.reset();

  document.getElementById('setup').style.display = 'none';
  document.getElementById('reader').style.display = 'none'; 
  document.getElementById('result').style.display = 'none';
  document.getElementById('history-view').style.display = 'block';
  document.getElementById('history-staff-display').textContent = staffInput;
  
  const listDiv = document.getElementById('history-list');
  listDiv.innerHTML = 'ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...';

  try {
    const snapshot = await firestore.collection('scans')
      .where('staff', '==', staffInput)
      .get();

    if (snapshot.empty) {
      listDiv.innerHTML = '<p>èª­ã¿å–ã‚Šå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }

    let docs = snapshot.docs.map(doc => doc.data());
    docs.sort((a, b) => {
      const tA = a.scanTimestamp ? a.scanTimestamp.toMillis() : 0;
      const tB = b.scanTimestamp ? b.scanTimestamp.toMillis() : 0;
      return tB - tA; 
    });

    let html = '<table class="history-table">';
    html += '<tr><th>åœ°ç‚¹</th><th>éƒ¨é–€</th><th>No.</th><th>æ°å</th><th>æ™‚é–“</th></tr>';
    
    docs.forEach(d => {
      const displayTime = d.time || '--:--:--';
      html += `<tr>
        <td style="text-align:left;">${d.name}</td>
        <td>${d.division}</td>
        <td>${d.bibNumber}</td>
        <td style="text-align:left;">${d.runnerName}</td>
        <td>${displayTime}</td>
      </tr>`;
    });
    html += '</table>';
    html += `<p style="text-align:right; font-size:14px;">ä»¶æ•°: ${docs.length}ä»¶</p>`;
    listDiv.innerHTML = html;
  } catch (error) {
    console.error("å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
    listDiv.innerHTML = '<p style="color:red;">å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
  }
}

function closeHistory() {
  document.getElementById('history-view').style.display = 'none';
  document.getElementById('setup').style.display = '';
}

// â–¼â–¼â–¼ é€šéçŠ¶æ³é›†è¨ˆã®ä¿®æ­£ç‰ˆï¼ˆshowStatsé–¢æ•°ã®ã¿å·®ã—æ›¿ãˆï¼‰ â–¼â–¼â–¼
async function showStats() {
  document.getElementById('setup').style.display = 'none';
  document.getElementById('reader').style.display = 'none';
  document.getElementById('result').style.display = 'none';
  document.getElementById('stats-view').style.display = 'block';

  const listDiv = document.getElementById('stats-list');
  listDiv.innerHTML = 'å…¨ãƒ‡ãƒ¼ã‚¿ã‚’è§£æãƒ»é›†è¨ˆä¸­...';

  try {
    const snapshot = await firestore.collection('scans').get();
    
    // 1. åœ°ç‚¹IDã¨é…åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å¯¾å¿œãƒãƒƒãƒ—ã‚’ä½œæˆ
    const locIndexMap = {};
    locations.forEach((loc, index) => {
      locIndexMap[String(loc.id)] = index;
    });

    // é›†è¨ˆç”¨ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
    // passedCounts: ãã®åœ°ç‚¹ã§ã‚¹ã‚­ãƒ£ãƒ³ã•ã‚ŒãŸå®Ÿæ•°
    // retireCounts: ãã®åœ°ç‚¹ã®æ‰‹å‰ã§ãƒªã‚¿ã‚¤ãƒ¤ã—ãŸäººæ•°ï¼ˆãã®åœ°ç‚¹ã«è¨ˆä¸Šï¼‰
    const passedCounts = new Array(locations.length).fill(0);
    const retireCounts = new Array(locations.length).fill(0);
    
    // ãƒ©ãƒ³ãƒŠãƒ¼ã”ã¨ã®æœ€çµ‚åˆ°é”åœ°ç‚¹ã‚’è¨˜éŒ²ï¼ˆãƒªã‚¿ã‚¤ãƒ¤è¨ˆä¸Šä½ç½®ã®è¨ˆç®—ç”¨ï¼‰
    // runnerStatus[bib] = { maxIndex: æ•°å€¤, isRetired: çœŸå½å€¤ }
    const runnerStatus = {};

    // 2. ãƒ‡ãƒ¼ã‚¿ã‚’èµ°æŸ»ã—ã¦ã€Œé€šéæ•°ã€ã¨ã€Œãƒ©ãƒ³ãƒŠãƒ¼ã®çŠ¶æ…‹ã€ã‚’æŠŠæ¡
    snapshot.forEach(doc => {
      const d = doc.data();
      const bib = d.bibNumber;
      const lid = String(d.id);
      
      // ãƒªã‚¿ã‚¤ãƒ¤ãƒ‡ãƒ¼ã‚¿ã‹ã©ã†ã‹ã®åˆ¤å®š
      const isRetireScan = (lid === '99' || (d.name && (d.name.includes('ãƒªã‚¿ã‚¤ãƒ¤') || d.name.includes('ãƒªã‚¿ã‚¤ã‚¢'))));
      
      const locIdx = locIndexMap[lid];

      // ãƒ©ãƒ³ãƒŠãƒ¼æƒ…å ±ã®åˆæœŸåŒ–
      if (!runnerStatus[bib]) {
        runnerStatus[bib] = { maxIndex: -1, isRetired: false };
      }

      if (isRetireScan) {
        runnerStatus[bib].isRetired = true;
      } else if (locIdx !== undefined) {
        // â˜…ä¿®æ­£ç‚¹: é€šéæ•°ã¯æ¨æ¸¬ã›ãšã€ã‚¹ã‚­ãƒ£ãƒ³ãŒã‚ã£ãŸåœ°ç‚¹ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
        passedCounts[locIdx]++;

        // ãƒªã‚¿ã‚¤ãƒ¤è¨ˆç®—ç”¨ã«ã€ãã®äººã®ã€Œæœ€å¤§åˆ°é”åœ°ç‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ã‚’æ›´æ–°ã—ã¦ãŠã
        if (locIdx > runnerStatus[bib].maxIndex) {
          runnerStatus[bib].maxIndex = locIdx;
        }
      }
    });

    // 3. ãƒªã‚¿ã‚¤ãƒ¤æ•°ã‚’ã€Œæœ€å¾Œã®é€šéåœ°ç‚¹ã® æ¬¡ã®åœ°ç‚¹ã€ã«åŠ ç®—
    Object.values(runnerStatus).forEach(r => {
      if (r.isRetired) {
        // æœ€å¾Œã«é€šéã—ãŸåœ°ç‚¹ã®ã€Œæ¬¡ã€ã®åœ°ç‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        const nextLocIndex = r.maxIndex + 1;
        
        // æ¬¡ã®åœ°ç‚¹ãŒå­˜åœ¨ã™ã‚Œã°ã€ãã“ã«ãƒªã‚¿ã‚¤ãƒ¤æ•°ã¨ã—ã¦è¨ˆä¸Š
        if (nextLocIndex < locations.length) {
          retireCounts[nextLocIndex]++;
        }
      }
    });

    // 4. ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
    let html = '<table class="stats-table">';
    html += '<tr><th>åœ°ç‚¹</th><th>é€šé</th><th>æœªé€šé</th><th>ãƒªã‚¿ã‚¤ãƒ¤</th></tr>';

    // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ï¼ˆID:2ï¼‰ã®é€šéè€…æ•°ã‚’ã€Œæ¯æ•°ã€ã¨ã—ã¦å–å¾—
    const startLocId = "2";
    const startLocIdx = locIndexMap[startLocId];
    // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã®é€šéæ•°ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯0ï¼‰
    const startRunnerCount = (startLocIdx !== undefined) ? passedCounts[startLocIdx] : 0;

    // ãƒªã‚¿ã‚¤ãƒ¤ç´¯ç©æ•°ï¼ˆæœªé€šéã®è¨ˆç®—ã«ä½¿ç”¨ï¼‰
    let cumulativeRetire = 0;

    locations.forEach((loc, index) => {
      // ãƒªã‚¿ã‚¤ãƒ¤åœ°ç‚¹ãƒã‚¹ã‚¿è‡ªä½“(ID:99ãªã©)ã¯è¡¨ç¤ºé™¤å¤–
      if (String(loc.id) === '99' || loc.name.includes("ãƒªã‚¿ã‚¤ãƒ¤") || loc.name.includes("ãƒªã‚¿ã‚¤ã‚¢")) {
        return;
      }

      const passed = passedCounts[index];      // å®Ÿã‚¹ã‚­ãƒ£ãƒ³æ•°
      const retiredHere = retireCounts[index]; // ã“ã“ã§ãƒªã‚¿ã‚¤ãƒ¤æ‰±ã„ã«ãªã£ãŸæ•°
      
      // ã“ã“ã¾ã§ã®ç´¯ç©ãƒªã‚¿ã‚¤ãƒ¤æ•°ã‚’æ›´æ–°
      cumulativeRetire += retiredHere;

      // æœªé€šéæ•°ã®è¨ˆç®—
      // å¼ï¼š ã‚¹ã‚¿ãƒ¼ãƒˆæ•°(æ¯æ•°) - ã“ã“ã®é€šéæ•° - ã“ã“ã¾ã§ã®ç´¯ç©ãƒªã‚¿ã‚¤ãƒ¤æ•°
      let unpassed = 0;
      if (index >= startLocIdx) {
        unpassed = startRunnerCount - passed - cumulativeRetire;
        // â€»é€šéã—å¿˜ã‚Œç­‰ã§è¨ˆç®—ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã‚‹å ´åˆã®ã‚¬ãƒ¼ãƒ‰
        if (unpassed < 0) unpassed = 0;
      }

      html += `<tr>
        <td style="text-align:left;">${loc.name}</td>
        <td style="font-weight:bold; color:blue;">${passed}</td>
        <td style="color:red;">${(index >= startLocIdx) ? unpassed : '-'}</td>
        <td>${retiredHere > 0 ? '+' + retiredHere : 0}</td>
      </tr>`;
    });

    html += '</table>';
    html += `<p style="text-align:right; font-size:14px; color:#666;">â€»æœªé€šé = ã‚¹ã‚¿ãƒ¼ãƒˆæ•° - (é€šé + ç´¯è¨ˆãƒªã‚¿ã‚¤ãƒ¤)</p>`;
    
    listDiv.innerHTML = html;

  } catch (error) {
    console.error("é›†è¨ˆã‚¨ãƒ©ãƒ¼:", error);
    listDiv.innerHTML = '<p style="color:red;">ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
  }
}

function closeStats() {
  document.getElementById('stats-view').style.display = 'none';
  document.getElementById('setup').style.display = '';
}

async function showReport() {
  document.getElementById('setup').style.display = 'none';
  document.getElementById('reader').style.display = 'none';
  document.getElementById('result').style.display = 'none';
  document.getElementById('report-view').style.display = 'block';

  const listDiv = document.getElementById('report-list');
  listDiv.innerHTML = 'å…¨ãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...';
  
  const select = document.getElementById('report-division-select');
  select.innerHTML = '<option value="">éƒ¨é–€ã‚’æŠ½å‡ºä¸­...</option>';

  try {
    const snapshot = await firestore.collection('scans').get();
    if (snapshot.empty) {
      listDiv.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      select.innerHTML = '<option value="">ãƒ‡ãƒ¼ã‚¿ãªã—</option>';
      return;
    }

    const locationIndexMap = {};
    locations.forEach((loc, index) => {
      locationIndexMap[String(loc.id)] = index;
    });

    const startLocationId = "2";
    
    const runnerMap = new Map();

    snapshot.forEach(doc => {
      const d = doc.data();
      const bib = d.bibNumber;
      const lid = String(d.id);
      
      const currentIndex = locationIndexMap[lid] !== undefined ? locationIndexMap[lid] : -1;
      const scanDate = d.scanTimestamp ? d.scanTimestamp.toDate() : null;

      if (!runnerMap.has(bib)) {
        runnerMap.set(bib, {
          latestData: d,
          startScanTime: (lid === startLocationId) ? scanDate : null,
          _locationIndex: currentIndex
        });
      } else {
        const entry = runnerMap.get(bib);

        if (lid === startLocationId) {
          entry.startScanTime = scanDate;
        }

        if (currentIndex > entry._locationIndex) {
          entry.latestData = d;
          entry._locationIndex = currentIndex;
        }
        else if (currentIndex === entry._locationIndex) {
           const currentTs = scanDate ? scanDate.getTime() : 0;
           const existingTs = entry.latestData.scanTimestamp ? entry.latestData.scanTimestamp.toMillis() : 0;
           if (currentTs > existingTs) {
             entry.latestData = d;
           }
        }
      }
    });

    allScanDataForReport = Array.from(runnerMap.values())
      .map(entry => {
        // â–¼â–¼â–¼ ãƒ‡ãƒ¼ã‚¿ã‚’æ­£è¦åŒ–ï¼ˆå…¨è§’â†’åŠè§’ã€ç©ºç™½å‰Šé™¤ï¼‰ä¿®æ­£ç®‡æ‰€ â–¼â–¼â–¼
        let rawDiv = entry.latestData.division || "";
        // æ–‡å­—åˆ—åŒ–ã—ã€å…¨è§’è‹±æ•°å­—ã‚’åŠè§’ã«å¤‰æ›
        let cleanDiv = String(rawDiv).replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, function(s) {
            return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
        });
        // ç©ºç™½ã‚’å‰Šé™¤ã—ã€å¤§æ–‡å­—ã«çµ±ä¸€
        cleanDiv = cleanDiv.trim().toUpperCase();
        // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

        return {
          ...entry.latestData,
          division: cleanDiv, // æ­£è¦åŒ–ã—ãŸéƒ¨é–€åã‚’ã‚»ãƒƒãƒˆ
          _realStartTime: entry.startScanTime,
          _locationIndex: entry._locationIndex
        };
      })
      .filter(d => {
        const isRetireId = String(d.id) === '99';
        const isRetireName = d.name && (d.name.includes('ãƒªã‚¿ã‚¤ãƒ¤') || d.name.includes('ãƒªã‚¿ã‚¤ã‚¢'));
        return !isRetireId && !isRetireName;
      });

    const divisions = new Set(allScanDataForReport.map(d => d.division));
    const sortedDivisions = Array.from(divisions).sort();
    
    select.innerHTML = '<option value="">éƒ¨é–€ã‚’é¸æŠ...</option>';
    sortedDivisions.forEach(div => {
      const opt = document.createElement('option');
      opt.value = div;
      opt.textContent = div;
      select.appendChild(opt);
    });

    listDiv.innerHTML = '<p>ä¸Šã®ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰éƒ¨é–€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>';

  } catch (error) {
    console.error("é€Ÿå ±ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
    listDiv.innerHTML = '<p style="color:red;">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
  }
}

function calculateElapsedTime(currentDateObj, startScanDateObj) {
  if (!currentDateObj || !startScanDateObj) return "--:--";

  const MS_PER_30_MIN = 30 * 60 * 1000;
  
  const roundedStartMs = Math.round(startScanDateObj.getTime() / MS_PER_30_MIN) * MS_PER_30_MIN;
  const roundedStartDate = new Date(roundedStartMs);

  const diffMs = currentDateObj - roundedStartDate;
  
  if (diffMs < 0) return "Startå‰"; 

  const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
  const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

  const hStr = String(diffHrs).padStart(2, '0');
  const mStr = String(diffMins).padStart(2, '0');

  return `${hStr}:${mStr}`;
}

function updateReportView() {
  const select = document.getElementById('report-division-select');
  const selectedDiv = select.value;
  const listDiv = document.getElementById('report-list');

  if (!selectedDiv) {
    listDiv.innerHTML = '<p>éƒ¨é–€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>';
    return;
  }

  if (typeof allScanDataForReport === 'undefined') {
    console.error("ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
    return;
  }

  let filtered = allScanDataForReport.filter(d => d.division === selectedDiv);

  // ã‚½ãƒ¼ãƒˆé †ï¼šåœ°ç‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é™é †ï¼ˆå¥¥ã«ã„ã‚‹äººé †ï¼‰ï¼ ã‚¹ã‚­ãƒ£ãƒ³æ™‚åˆ»æ˜‡é †ï¼ˆå…ˆã«ç€ã„ãŸé †ï¼‰
  filtered.sort((a, b) => {
    if (b._locationIndex !== a._locationIndex) {
      return b._locationIndex - a._locationIndex; 
    }
    const tA = a.scanTimestamp ? a.scanTimestamp.toMillis() : 0;
    const tB = b.scanTimestamp ? b.scanTimestamp.toMillis() : 0;
    return tA - tB; 
  });

  // â–¼â–¼â–¼ ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã€Œé€šéã€ã‚’è¿½åŠ  â–¼â–¼â–¼
  let html = '<table class="report-table">';
  html += '<tr><th>é †ä½</th><th>No.</th><th>æ°å</th><th>åœ°ç‚¹</th><th>é€šé</th><th>çµŒé</th></tr>';

  filtered.forEach((d, index) => {
    let elapsedTime = "--:--";
    
    const currentObj = d.scanTimestamp ? d.scanTimestamp.toDate() : null;
    
    // çµŒéæ™‚é–“ã®è¨ˆç®—
    if (currentObj && d._realStartTime) {
      elapsedTime = calculateElapsedTime(currentObj, d._realStartTime);
    } else if (!d._realStartTime) {
        elapsedTime = "Startæœª"; 
    }

    // â–¼â–¼â–¼ é€šéæ—¥æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä½œæˆ (ä¾‹: 19æ—¥ 14:30) â–¼â–¼â–¼
    let passageLabel = d.time || ""; // äºˆå‚™
    if (currentObj) {
      const dd = currentObj.getDate();
      const hh = String(currentObj.getHours()).padStart(2, '0');
      const mm = String(currentObj.getMinutes()).padStart(2, '0');
      passageLabel = `${dd}æ—¥<br>${hh}:${mm}`; // æ—¥ä»˜ã¨æ™‚åˆ»ã‚’æ”¹è¡Œã—ã¦è¡¨ç¤º
    }

    html += `<tr>
      <td style="font-weight:bold;">${index + 1}</td> <td>${d.bibNumber}</td>
      <td style="text-align:left;">${d.runnerName}</td>
      <td style="text-align:left;">${d.name}</td>
      <td style="font-size: 14px; line-height: 1.2;">${passageLabel}</td>
      <td style="font-weight:bold;">${elapsedTime}</td>
    </tr>`;
  });
  html += '</table>';
  html += `<p style="text-align:right; font-size:14px;">è©²å½“: ${filtered.length}å</p>`;

  listDiv.innerHTML = html;
}

function closeReport() {
  document.getElementById('report-view').style.display = 'none';
  document.getElementById('setup').style.display = '';
}

/**
 * â–¼â–¼â–¼ ãƒªã‚¿ã‚¤ãƒ¤ä¸€è¦§è¡¨ç¤ºæ©Ÿèƒ½ (ä¿®æ­£ç‰ˆ) â–¼â–¼â–¼
 */
async function showRetireList() {
  document.getElementById('setup').style.display = 'none';
  document.getElementById('retire-list-view').style.display = 'block';

  const listDiv = document.getElementById('retire-list-content');
  listDiv.innerHTML = 'å…¨ãƒ‡ãƒ¼ã‚¿ã‚’è§£æã—ã¦ãƒªã‚¿ã‚¤ãƒ¤çŠ¶æ³ã‚’å–å¾—ä¸­...';

  try {
    // ãƒªã‚¿ã‚¤ãƒ¤æƒ…å ±ã ã‘ã§ãªãã€ç›´å‰ã®ä½ç½®ã‚’çŸ¥ã‚‹ãŸã‚ã«ã€Œå…¨ã‚¹ã‚­ãƒ£ãƒ³ã€ã‚’å–å¾—ã—ã¾ã™
    const snapshot = await firestore.collection('scans').get();

    if (snapshot.empty) {
      listDiv.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }

    // 1. ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ©ãƒ³ãƒŠãƒ¼ã”ã¨ã«æ•´ç†ã™ã‚‹
    // runners[ã‚¼ãƒƒã‚±ãƒ³] = { retireData: {}, lastNormalData: {} }
    const runners = {};

    snapshot.forEach(doc => {
      const d = doc.data();
      const bib = d.bibNumber;
      const lid = String(d.id);
      const isRetire = (lid === '99' || (d.name && (d.name.includes('ãƒªã‚¿ã‚¤ãƒ¤') || d.name.includes('ãƒªã‚¿ã‚¤ã‚¢'))));

      if (!runners[bib]) {
        runners[bib] = { retireData: null, lastNormalData: null };
      }

      if (isRetire) {
        // ãƒªã‚¿ã‚¤ãƒ¤ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
        runners[bib].retireData = d;
      } else {
        // é€šå¸¸ã®é€šéãƒ‡ãƒ¼ã‚¿ã®å ´åˆã€ä¸€ç•ªæ–°ã—ã„ã‚‚ã®ã‚’ä¿æŒï¼ˆï¼æœ€çµ‚é€šéåœ°ç‚¹ï¼‰
        const currentLast = runners[bib].lastNormalData;
        
        const thisTime = d.scanTimestamp ? d.scanTimestamp.toMillis() : 0;
        const lastTime = (currentLast && currentLast.scanTimestamp) ? currentLast.scanTimestamp.toMillis() : -1;

        if (thisTime > lastTime) {
          runners[bib].lastNormalData = d;
        }
      }
    });

    // 2. ãƒªã‚¿ã‚¤ãƒ¤ã—ãŸäººã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
    const retireList = [];
    Object.keys(runners).forEach(bib => {
      const r = runners[bib];
      if (r.retireData) {
        retireList.push({
          ...r.retireData,
          // ç›´å‰ã®åœ°ç‚¹åã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°ã€ŒStartå‰ã€ã‚„ã€Œä¸æ˜ã€ï¼‰
          _lastLocationName: r.lastNormalData ? r.lastNormalData.name : 'Startå‰'
        });
      }
    });

    if (retireList.length === 0) {
      listDiv.innerHTML = '<p>ãƒªã‚¿ã‚¤ãƒ¤ç™»éŒ²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }
    
    // 3. æ—¥ä»˜ã®æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
    retireList.sort((a, b) => {
      const tA = a.scanTimestamp ? a.scanTimestamp.toMillis() : 0;
      const tB = b.scanTimestamp ? b.scanTimestamp.toMillis() : 0;
      return tB - tA; 
    });

    // 4. ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆï¼ˆåˆ—ã‚’è¿½åŠ ï¼šéƒ¨é–€, No, æ°å, â˜…æœ€çµ‚é€šé, æ—¥æ™‚, ä½ç½®ï¼‰
    let html = '<table class="retire-table">';
    html += '<tr><th>éƒ¨é–€</th><th>No.</th><th>æ°å</th><th>æœ€çµ‚é€šé</th><th>æ—¥æ™‚</th><th>ä½ç½®</th></tr>';

    retireList.forEach(d => {
      // ä½ç½®æƒ…å ±ãƒªãƒ³ã‚¯ã®ä½œæˆ
      let locationLink = "ãƒ¼";
      if (d.latitude && d.longitude) {
        const mapUrl = `https://www.google.com/maps?q=${d.latitude},${d.longitude}`;
        locationLink = `<a href="${mapUrl}" target="_blank" style="text-decoration:underline; color:blue; cursor:pointer;">ğŸ“ç¢ºèª</a>`;
      }

      html += `<tr>
        <td>${d.division}</td>
        <td>${d.bibNumber}</td>
        <td style="text-align:left;">${d.runnerName}</td>
        <td style="font-weight:bold; color:#555;">${d._lastLocationName}</td>
        <td>${d.date}<br>${d.time}</td>
        <td>${locationLink}</td>
      </tr>`;
    });

    html += '</table>';
    html += `<p style="text-align:right; font-size:14px;">åˆè¨ˆ: ${retireList.length}å</p>`;

    listDiv.innerHTML = html;

  } catch (error) {
    console.error("ãƒªã‚¿ã‚¤ãƒ¤ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
    listDiv.innerHTML = '<p style="color:red;">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
  }
}

function closeRetireList() {
  document.getElementById('retire-list-view').style.display = 'none';
  document.getElementById('setup').style.display = '';
}
// â–²â–²â–² ãƒªã‚¿ã‚¤ãƒ¤ä¸€è¦§æ©Ÿèƒ½ã“ã“ã¾ã§ â–²â–²â–²


function getLocation() {
  return new Promise((resolve) => {
    if (!navigator.geolocation) {
      console.warn("Geolocation is not supported by this browser.");
      resolve(null);
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (position) => {
        resolve({
          lat: position.coords.latitude,
          lng: position.coords.longitude
        });
      },
      (error) => {
        console.warn("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—:", error.message);
        resolve(null); 
      },
      {
        enableHighAccuracy: true, 
        timeout: 5000,            
        maximumAge: 0             
      }
    );
  });
}
  
function startScanner() {
  const video = document.getElementById('video');
  if (!codeReader) {
    codeReader = new ZXing.BrowserQRCodeReader();
  }
  document.getElementById('message').textContent = 'èª­ã¿å–ã‚Šä¸­...';

  codeReader.decodeFromVideoDevice(undefined, video, async (result, err) => { 
    if (result) {
      codeReader.reset(); 
      
      const text = result.text.trim();
      const parts = text.split('/');
      
      if (parts.length >= 4) {
        const [division, bibNumber, runnerName, gender, startTime = ''] = parts;
        
        let locData = null;

        if (selectedLocationId == '99') {
          document.getElementById('message').textContent = 'ä½ç½®æƒ…å ±å–å¾—ä¸­...';
          locData = await getLocation();
        }

        document.getElementById('message').textContent = 'èª­ã¿å–ã‚ŠæˆåŠŸ';

        const scanTimeObject = new Date();
        
        const scanData = {
          id: selectedLocationId,
          name: selectedLocationName,
          division,
          bibNumber,
          runnerName,
          gender,
          startTime,
          latitude: locData ? locData.lat : null,
          longitude: locData ? locData.lng : null,
          
          scanTimestamp: firebase.firestore.Timestamp.fromDate(scanTimeObject),
          date: scanTimeObject.toLocaleDateString('ja-JP'),
          time: scanTimeObject.toLocaleTimeString('ja-JP'),
          staff,
          serverTimestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        showPopup(scanData); 
      } else {
        document.getElementById('message').textContent = 'ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™';
        setTimeout(startScanner, 1000);
      }
    }
  }, { video: { facingMode: "environment" } });
}

function showPopup(scanData) {
  const overlay = document.getElementById('popup-overlay');
  const title = document.getElementById('popup-title');
  const info = document.getElementById('popup-info');
  const popup = document.getElementById('popup');

  title.textContent = "ãƒã‚§ãƒƒã‚¯OK";
  title.style.color = "green";

  info.innerHTML = `
    åœ°ç‚¹ï¼š${scanData.name}<br>
    éƒ¨é–€ï¼š${scanData.division}<br>
    ã‚¼ãƒƒã‚±ãƒ³ï¼š${scanData.bibNumber}<br>
    æ°åï¼š${scanData.runnerName}
  `;

  popup.querySelectorAll('button').forEach(btn => btn.remove());

  const okBtn = document.createElement('button');
  okBtn.textContent = "OK";
  okBtn.onclick = () => {
    uploadToFirebase(scanData); 
    continueScan(); 
  };
  popup.appendChild(okBtn);

  const endBtn = document.createElement('button');
  endBtn.textContent = "çµ‚äº†";
  endBtn.onclick = endApp;
  popup.appendChild(endBtn);

  overlay.style.display = 'flex';
}

function continueScan() {
  document.getElementById('popup-overlay').style.display = 'none';
  startScanner(); 
}

function endApp() {
  if (codeReader) {
    codeReader.reset();
  }
  document.getElementById('popup-overlay').style.display = 'none';
  document.getElementById('setup').style.display = '';
  document.getElementById('reader').style.display = 'none';
  document.getElementById('result').style.display = 'none';
}

async function uploadToFirebase(data) {
  if (!firestore) {
    console.error("Firestore is not initialized.");
    document.getElementById('message').textContent = 'DBæœªæ¥ç¶šã‚¨ãƒ©ãƒ¼'; 
    return;
  }

  const docId = `${data.id}_${data.bibNumber}`;
  const docRef = firestore.collection("scans").doc(docId);

  try {
    await firestore.runTransaction(async (transaction) => {
      const doc = await transaction.get(docRef);
      if (doc.exists) {
        throw new Error("already-exists");
      }
      transaction.set(docRef, data);
    });
    
    console.log("Transaction successfully committed (åˆå›):", docId);
    document.getElementById('message').textContent = `${data.bibNumber} ä¿å­˜å®Œäº†`;

    if (String(data.id) === '99' || data.name.includes("ã€ãƒªã‚¿ã‚¤ãƒ¤ã€‘") || data.name.includes("ã€ãƒªã‚¿ã‚¤ãƒ¤ã€‘")) {
      firestore.collection('broadcast').doc('latest_retire').set({
        bibNumber: data.bibNumber,
        runnerName: data.runnerName,
        locationName: data.name,
        time: data.time,
        staff: data.staff,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).catch((err) => {
        console.warn("é€Ÿå ±ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ¼ã‚¿ä¿å­˜ã¯æˆåŠŸï¼‰:", err);
      });
    }

  } catch (error) {
    if (error.message === "already-exists") {
      console.warn("Transaction failed (é‡è¤‡ã‚¹ã‚­ãƒ£ãƒ³):", docId);
      document.getElementById('message').textContent = `${data.bibNumber} ã¯èª­ã¿å–ã‚Šæ¸ˆã¿`;
    } else {
      console.error("Transaction failed: ", error);
      document.getElementById('message').textContent = `ä¿å­˜ã‚¨ãƒ©ãƒ¼(ã‚­ãƒ£ãƒƒã‚·ãƒ¥è©¦è¡Œ)`;
    }
  }
}

function showCustomPopup({ title = "", message = "", buttons = [], callback = null }) {
  const overlay = document.getElementById('popup-overlay');
  const popup = document.getElementById('popup');
  const titleElem = document.getElementById('popup-title');
  const infoElem = document.getElementById('popup-info');

  titleElem.textContent = title;
  titleElem.style.color = (title === "ã‚¨ãƒ©ãƒ¼" ? "red" : ""); 
  infoElem.innerHTML = message;

  popup.querySelectorAll('button').forEach(btn => btn.remove());

  buttons.forEach(({ text, value }) => {
    const btn = document.createElement('button');
    btn.textContent = text;
    btn.onclick = () => {
      overlay.style.display = 'none';
      if (callback) callback(value);
    };
    popup.appendChild(btn);
  });

  overlay.style.display = 'flex';
}

let lastRetireAlertTime = new Date().getTime(); 

function startRetireListener() {
  firestore.collection('broadcast').doc('latest_retire')
    .onSnapshot((doc) => {
      if (!doc.exists) return;
      
      const d = doc.data();
      if (!d.timestamp) return; 

      const alertTime = d.timestamp.toMillis();
      const now = new Date().getTime();

      if (alertTime > lastRetireAlertTime && (now - alertTime) < 10 * 60 * 1000) {
        lastRetireAlertTime = alertTime; 
        showRetireAlert(d);
      }
    }, (error) => {
      console.error("é€Ÿå ±å—ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
    });
}

function showRetireAlert(data) {
  const banner = document.getElementById('retire-banner');
  const info = document.getElementById('retire-info');
  
  info.innerHTML = `
    No.${data.bibNumber} <strong>${data.runnerName}</strong> ã•ã‚“<br>
    å ´æ‰€: ${data.locationName}
  `;
  
  if (navigator.vibrate) {
    navigator.vibrate([500, 200, 500]); 
  }

  banner.style.top = "0";

  setTimeout(() => {
    banner.style.top = "-200px";
  }, 7000);
}

try {
  firebase.initializeApp(firebaseConfig);
  firestore = firebase.firestore();

  firestore.enablePersistence().catch((err) => {
    console.warn("Persistence disabled:", err.code);
  });

  setTimeout(() => {
    initializeAppLogic();
    startRetireListener(); 
  }, 300);

} catch (e) {
  console.error("Firebase initialization error:", e);
  alert("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
  initializeAppLogic();
}
</script>
</body>
</html>
